<!DOCTYPE html5>
<html>
  <head>
    <meta charset="utf-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/1.7.9/fabric.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
  </head>
  <style>
    .canvas-container 
    {
    margin:0 auto ;
    }
  </style>
  <body style="display:flex;margin:0;height:850px;padding:10px;">
    
    <div style="background-color:grey;flex:1 0 auto;">
      <h1>Instruments</h1>
    </div>

    <div style="flex:8 0 auto;margin:0 10px;display:flex; flex-direction:column;">
      <div style="flex:1 0 auto;">
	<canvas id="c"  style="border:1px solid #ccc;"></canvas>
      </div>
      <div style="flex:9 0 auto;">
	<h1>Status pannel</h1>
      </div>
    </div>

    <div style="background-color:grey;flex:1 0 auto;">
      <h1>Configuration</h1>
    </div>

    <script>
      
      var table = new Object();
      var pingId = "";
      var delId = "";

      fabric.Canvas.prototype.getItemByName = function(name) {
        var object = null,
            objects = this.getObjects();
      
        for (var i = 0, len = this.size(); i < len; i++) {
          if (objects[i].myName && objects[i].myName === name) {
	    object = objects[i];
	    break;
	  }
        }					     
	return object;
     };

      function deleteLink(id){
	var tmpline = canvas.getItemByName(id);
        var names = tmpline.myName.split("_");
        delete table[names[0]][names[1]];
        delete table[names[1]][names[0]];
        tmpline.remove();
      };

      function addLink(firstId, secondId){
        var rect1 = canvas.getItemByName(firstId);
        var rect2 = canvas.getItemByName(secondId);

        if(rect1.left > rect2.left){
          rect2 = rect1;
          rect1 = canvas.getItemByName(secondId);
        }
	var length = rect1.left + Math.pow(Math.pow(rect2.width/2 , 2) + Math.pow(rect2.height/2 ,2), 1/2) + Math.pow(Math.pow(rect2.left - rect1.left , 2) + Math.pow(rect2.top - rect1.top ,2), 1/2);      
        var line = new fabric.Line([rect1.left+rect1.width/2, rect1.top+rect1.height/2, length , rect1.top+rect1.height/2], {
        strokeWidth: 5,
        fill: 'black',
        stroke: 'black',
        angle: Math.atan((rect2.top - rect1.top)/(rect2.left - rect1.left)) * (180/Math.PI),
        myName: firstId + "_" + secondId
        
        });
        canvas.add(line);      
        canvas.sendToBack(line)
        line.lockMovementX = line.lockMovementY = true;
	line.hasControls = line.hasBorders = false;
	line.hoverCursor = 'pointer';

        line.on('mousedown', function(e){
	  if(delId !== line.myName){
	    delId = line.myName;
	  }
	  else{
            deleteLink(line.myName);
	  }
	  pingId = "";
        });

        table[firstId][secondId] = table[secondId][firstId] = firstId + "_" + secondId; 
      };

      function deleteNode(id){
        for(name in table[id]){
          var tmpline = canvas.getItemByName(table[id][name]);
          tmpline.remove();
        }				       
        delete table[id];
        for(name in table){
          if(table[name].hasOwnProperty(id)){
            delete table[name][id];
          }
        }
	canvas.remove(canvas.getItemByName(id));
      };

      function ping(fpid, spid){
	$.get("/getPing",{sender: fpid, reciver: spid}).done( function(data){ 
	  return data; 
	});
      };

      function addNode(corx, cory, id, type){

        if(type === 1){
        fabric.Image.fromURL('./static/img/switch.jpg', function(oImg) {      
          var img1 = oImg.set({width:160, height:60,top:20});
          img1.myName= id + "_Icon";

          img1.on('mousedown', function(e){
	    if(pingId == ""){
	      pingId = id;
	    }
	    else{
	      ping(pingId, id);
	      pingId = "";
	    }
          });

          fabric.Image.fromURL('./static/img/gear.png', function(oImg) {
            var img2 = oImg.set({width:20,height:20,left:140});
	    img2.myName= id + "_Gear";

            fabric.Image.fromURL('./static/img/cross.png', function(oImg) {
            var img3 = oImg.set({width:20,height:20,left:120});
	    img3.myName= id + "_Cross";

            img3.on('mousedown', function(e){
              deleteNode(id);
            });

            var mytext = new fabric.Text(id, {left: 0, myName: id + "_Text"});

            mytext.scaleToHeight(20);
            var mygroup =   new fabric.Group([ img1, img2, img3, mytext], { left: corx, top: cory, myName: id, subTargetCheck: true, hasControls: false, hasBorders: false});

            mygroup.on('moving', function(e){
              for(name in table[id]){
                var tmpline = canvas.getItemByName(table[id][name]);
                var names = tmpline.myName.split("_");
	        var tmpr1 = canvas.getItemByName(names[0]);
                var tmpr2 = canvas.getItemByName(names[1]);
	        if(tmpr1.left > tmpr2.left){
                  tmpr2 = tmpr1;
                  tmpr1 = canvas.getItemByName(names[1]);
                }
	        var length = tmpr1.left + Math.pow(Math.pow(tmpr2.width/2 ,2) + Math.pow(tmpr2.height/2 ,2), 1/2) + Math.pow(Math.pow(tmpr2.left - tmpr1.left,2) + Math.pow(tmpr2.top - tmpr1.top,2), 1/2);
                var newangle = Math.atan((tmpr2.top - tmpr1.top)/(tmpr2.left - tmpr1.left)) * (180/Math.PI);
                tmpline.set({x1: tmpr1.left+tmpr1.width/2, x2: length, y1: tmpr1.top+tmpr1.height/2, y2: tmpr1.top+tmpr1.height/2, angle: newangle});  
                tmpline.setCoords();  
	        canvas.renderAll(); 
                pingId = "";          
              }
            });

	    mygroup.on('mousedown', function(e){
	      delId = "";
            });

	    canvas.add(mygroup);
            table[id] = new Object();			       
            });
          });
        });		
      }

      if(type === 2){
        fabric.Image.fromURL('./static/img/terminal.jpg', function(oImg) {      
          var img1 = oImg.set({width:160, height:60,top:20});
          img1.myName= id + "_Icon";

          img1.on('mousedown', function(e){
	    if(pingId == ""){
	      pingId = id;
	    }
	    else{
	      ping(pingId, id);
	      pingId = "";
	    }
          });

          fabric.Image.fromURL('./static/img/gear.png', function(oImg) {
            var img2 = oImg.set({width:20,height:20,left:140});
	    img2.myName= id + "_Gear";
      
            fabric.Image.fromURL('./static/img/cross.png', function(oImg) {
            var img3 = oImg.set({width:20,height:20,left:120});
	    img3.myName= id + "_Cross";

            img3.on('mousedown', function(e){
	      deleteNode(id);
            });

            var mytext = new fabric.Text(id, {left: 0, myName: id + "_Text"});
            mytext.scaleToHeight(20);
            var mygroup =   new fabric.Group([ img1, img2, img3, mytext], { left: corx, top: cory, myName: id, subTargetCheck: true, hasControls: false, hasBorders: false});

            mygroup.on('moving', function(e){
              for(name in table[id]){
                var tmpline = canvas.getItemByName(table[id][name]);
                var names = tmpline.myName.split("_");
	        var tmpr1 = canvas.getItemByName(names[0]);
                var tmpr2 = canvas.getItemByName(names[1]);
	        if(tmpr1.left > tmpr2.left){
                  tmpr2 = tmpr1;
                  tmpr1 = canvas.getItemByName(names[1]);
                }
	        var length = tmpr1.left + Math.pow(Math.pow(tmpr2.width/2 ,2) + Math.pow(tmpr2.height/2 ,2), 1/2) + Math.pow(Math.pow(tmpr2.left - tmpr1.left,2) + Math.pow(tmpr2.top - tmpr1.top,2), 1/2);
                var newangle = Math.atan((tmpr2.top - tmpr1.top)/(tmpr2.left - tmpr1.left)) * (180/Math.PI);
                tmpline.set({x1: tmpr1.left+tmpr1.width/2, x2: length, y1: tmpr1.top+tmpr1.height/2, y2: tmpr1.top+tmpr1.height/2, angle: newangle}); 
                tmpline.setCoords(); 
	        canvas.renderAll();
                pingId = "";   
              }
            });

	    mygroup.on('mousedown', function(e){
	      delId = "";
            });

	    canvas.add(mygroup);
            table[id] = new Object();		       
            });
          });
        });		
      }

      if(type === 3){
        fabric.Image.fromURL('./static/img/router.jpg', function(oImg) {      
          var img1 = oImg.set({width:160, height:60,top:20});
          img1.myName= id + "_Icon";

          img1.on('mousedown', function(e){
	    if(pingId == ""){
	      pingId = id;
	    }
	    else{
	      ping(pingId, id);
	      pingId = "";
	    }
          });

          fabric.Image.fromURL('./static/img/gear.png', function(oImg) {
            var img2 = oImg.set({width:20,height:20,left:140});
	    img2.myName= id + "_Gear";
      
            fabric.Image.fromURL('./static/img/cross.png', function(oImg) {
            var img3 = oImg.set({width:20,height:20,left:120});
	    img3.myName= id + "_Cross";

            img3.on('mousedown', function(e){
	      deleteNode(id);
            });

            var mytext = new fabric.Text(id, {left: 0, myName: id + "_Text"});
            mytext.scaleToHeight(20);
            var mygroup =   new fabric.Group([ img1, img2, img3, mytext], { left: corx, top: cory, myName: id, subTargetCheck: true, hasControls: false, hasBorders: false});

            mygroup.on('moving', function(e){
              for(name in table[id]){
                var tmpline = canvas.getItemByName(table[id][name]);
                var names = tmpline.myName.split("_");
	        var tmpr1 = canvas.getItemByName(names[0]);
                var tmpr2 = canvas.getItemByName(names[1]);
	        if(tmpr1.left > tmpr2.left){
                  tmpr2 = tmpr1;
                  tmpr1 = canvas.getItemByName(names[1]);
                }
	        var length = tmpr1.left + Math.pow(Math.pow(tmpr2.width/2 ,2) + Math.pow(tmpr2.height/2 ,2), 1/2) + Math.pow(Math.pow(tmpr2.left - tmpr1.left,2) + Math.pow(tmpr2.top - tmpr1.top,2), 1/2);
                var newangle = Math.atan((tmpr2.top - tmpr1.top)/(tmpr2.left - tmpr1.left)) * (180/Math.PI);
                tmpline.set({x1: tmpr1.left+tmpr1.width/2, x2: length, y1: tmpr1.top+tmpr1.height/2, y2: tmpr1.top+tmpr1.height/2, angle: newangle}); 
                tmpline.setCoords();  
	        canvas.renderAll();   
                pingId = "";             
              }
            });

	    mygroup.on('mousedown', function(e){
	      delId = "";
            });

	    canvas.add(mygroup);
            table[id] = new Object();			       
            });
          });
        });		
      }
      };

      function loadTopology(){
        //get json string from server and convert it to object
	var canvasTable = new Object();
	//$.get("/getSavedTopo").done( function(data){ 
	$.get("/getSavedTopo",function(data){ 
	  canvasTable = JSON.parse(data); 
	  alert("Data = " + data);
	});
	if( canvasTable.hasOwnProperty("Hosts") ){
          for(index in canvasTable["Hosts"]){
	    var id = canvasTable["Hosts"][index]["id"];
	    var x = canvasTable["Hosts"][index]["x"];
	    var y = canvasTable["Hosts"][index]["y"];
	    addNode(x,y,id,1);
	  }
	}
	else{
	 alert("No hosts");
	}
	if( canvasTable.hasOwnProperty("Switches") ){
	  for(index in canvasTable["Switches"]){
	    var id = canvasTable["Switches"][index]["id"];
	    var x = canvasTable["Switches"][index]["x"];
	    var y = canvasTable["Switches"][index]["y"];
	    addNode(x,y,id,2);
	  }
	}
	else{
	 alert("No switces");
	}
	if( canvasTable.hasOwnProperty("Routers") ){
	  for(index in canvasTable["Routers"]){
	    var id = canvasTable["Routers"][index]["id"];
	    var x = canvasTable["Routers"][index]["x"];
	    var y = canvasTable["Routers"][index]["y"];
	    addNode(x,y,id,3);
	  }
	}
	else{
	 alert("No Routers");
	}
	if( canvasTable.hasOwnProperty("Links") ){
	  for(index in canvasTable["Links"]){
	    var id1 = canvasTable["Links"][index][0];
	    var id2 = canvasTable["Links"][index][1];
	    addLink(id1, id2);
	  }
	}
	else{
	 alert("No links");
	}
      };

      var canvas = new fabric.Canvas('c', { selection: false });
      canvas.setWidth(800);
      canvas.setHeight(600);
      canvas.on('mouse:down', function(e){
	if(! e.target){
	  pingId = "";
	  delId = "";
	}
      });


      //For tests
      var flag1 = 1;
      var flag2 = 1;
      
      addNode(100,200,"S1",1);
      addNode(100,400,"S2",1);
      addNode(400,200,"H1",2);
      addNode(400,400,"H2",2);
      addNode(650,350,"R1",3);

      canvas.renderAll();

      //Test on adding line between nods      
      var myrect = new fabric.Rect({
      left: 100,
      top: 100,
      fill: 'red',
      width: 20,
      height: 20,
      myName: "MR1"
      });
      myrect.on('mousedown', function(e){
      if(flag1 == 1 && flag2 == 1)
      {
      addLink("S1","H1");
      addLink("S1","H2");
      addLink("S1","S2");
      addLink("S2","H1");
      addLink("S2","H2");
      addLink("H1","H2");
      addLink("R1","S1");
      addLink("R1","S2");
      addLink("R1","H1");
      addLink("R1","H2");

      flag1 = 0;
      flag2 = 0;
      }
      });
      myrect.hasControls = false;
      myrect.hasBorders = false;
      canvas.add(myrect);

      //Test load JSON    
      var myrect2 = new fabric.Rect({
      left: 200,
      top: 100,
      fill: 'red',
      width: 20,
      height: 20,
      myName: "MR2"
      });
      myrect2.on('mousedown', function(e){
      loadTopology();
      });
      myrect2.hasControls = false;
      myrect2.hasBorders = false;
      canvas.add(myrect2);


     </script>
  </body>
</html>
